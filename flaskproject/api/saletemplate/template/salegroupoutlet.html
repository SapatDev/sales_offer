{% extends 'base.html' %}


{% block content %}
<div class="main-panel">
  <div class="content-wrapper">

    <div class="col-lg-12 stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title" id="offerName"></h4>

            <div style="display: flex; justify-content: flex-end;  margin-bottom: 15px;">
              <button class="btn btn-sm btn-secondary" role="button"  onclick="tableToExcel()">Download as Excel</button>
           </div>
            <!-- <p class="card-description">
              Add class <code>.table-{color}</code>
            </p> -->

            <div class="num_rows">
              <div class="form-group">
                <!--		Show Numbers Of Rows 		-->
                <select class="form-control" name="state" id="maxRows">
  
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                  <option value="70">70</option>
                  <option value="100">100</option>
                  <option value="5000">Show ALL Rows</option>
                </select>
  
              </div>
            </div>
  
            <div class="tb_search">
              <input type="text" id="search_input_all" onkeyup="FilterkeyWord_all_table()" class="form-control"
              placeholder="Search" aria-label="Search Stock Data">
            </div>

            <div class="table-responsive pt-3">
              <table class="table table-striped"  id="datatablesSimple">
                <thead>
                    <tr>
                        

                       <th>OutletId</th>
                       <th>BeatName</th>
                       <th>OutletName</th>
                       {% for type_id in unique_type %}
                       <th>{{type_id}}</th>
                       {% endfor %}
                     
                     
                       
                        
                    </tr>
                   
    
                </thead>
               
                    <tbody>
                        <!--  total sum in type_Id realetd -->
                        {% set coupon_sums = {} %} 
                        {% for coupon_typeId in unique_coupon_type %}
                            {% set coupon_sums = coupon_sums.update({coupon_typeId: 0}) %}
                        {% endfor %}
<!-- Dictionary to hold sums for each coupon_typeId -->

                        {% for outlet in outletId %}
                        <tr>
                            <td>{{outlet}}</td>

                            <td>
                                {% set beatname = dict_list|selectattr('outletId', 'eq',outlet)|map(attribute='beatname')|list|first %}
                                {{ beatname if beatname is defined else '' }}
                            </td>

                                <!-- {{unique_beatname}}</td> -->
                            <td>
                                {% set outletName = dict_list|selectattr('outletId', 'eq',outlet)|map(attribute='outletName')|list|first %}
                                {{ outletName if outletName is defined else '' }}
                                <!-- {{unique_outletName}} -->
                            </td>

                            {% set scheme_counts = {} %}
                            
                            {% for item in dict_list if item['outletId'] == outlet %}
                            {% set _ = scheme_counts.update({item['coupon_type']: item['scheme_count']}) %}
                            {% endfor %}
                            {% for type_id in unique_type %}
                            {% if type_id in scheme_counts %} 
                            <td>{{ scheme_counts[type_id] }}</td>
                            {% else %}
                            <td>0</td>
                            {% endif %}
                        <!--  total sum in type_Id realetd -->
                            {% set coupon_sums = coupon_sums.update({type_id: (coupon_sums[type_id]|default(0)) + (scheme_counts[type_id]|default(0))}) %}
                        <!--  total sum in type_Id realetd -->
                            {% endfor %}

                        </tr>
                        {% endfor %}

                        <!--  total sum in type_Id realetd -->

                         <tr>
                        <td></td> 
                        <td></td> 
                        <td><h4>Grand-Total</h4></td> 
                        {% for type_id in unique_type %}
                            <td>{{ coupon_sums[type_id] }}</td>
                        {% endfor %}
                        <!--  total sum in type_Id realetd -->
                    </tr>
                      
                      
                    </tbody> 
              </table>
            </div>
          </div>
        </div>
      </div>

    
  </div>
 
</div>



<script>
  function tableToExcel() {
          const table = document.getElementById('datatablesSimple');
          const wb = XLSX.utils.table_to_book(table, { sheet: 'SheetJS' });
          const wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' });
  
          function s2ab(s) {
              const buf = new ArrayBuffer(s.length);
              const view = new Uint8Array(buf);
              for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
              return buf;
          }
          saveAs(new Blob([s2ab(wbout)], { type: 'application/octet-stream' }), 'sales data.xlsx');
      }
  
    
    </script>

<script>
  document.getElementById("offerName").innerText = localStorage.getItem("offername")
  
</script>

<script>
function setOfferName(id) {
    // Set the action of the form dynamically based on the clicked item's id
    document.getElementById('myForm').action = "/offer/{{ offerID }}/" + id;
}


</script>
{% endblock %}